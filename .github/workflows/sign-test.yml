name: Sign Test APK

on:
  workflow_run:
    workflows: ["Build"]
    types: [completed]

permissions:
  contents: read
  actions: read  # Required to download artifacts

jobs:
  sign-test:
    name: Sign Test APK
    runs-on: ubuntu-latest
    environment: test:ci
    # Only run if build succeeded and is from a pull request
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.event == 'pull_request' }}
    steps:
      # NOTE: Intentionally NOT checking out PR code to prevent untrusted code execution
      # This job operates on artifacts only

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android build tools
        run: |
          sdkmanager "build-tools;34.0.0"

      - name: Download test APK from build workflow
        uses: actions/download-artifact@v4
        with:
          name: letterbox-staging-apk
          path: ./artifacts
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}

      - name: List downloaded artifacts
        run: ls -la ./artifacts

      - name: Sign APK
        run: |
          set -euo pipefail
          umask 077

          # Rehydrate keystore
          printf '%s' "${{ secrets.ANDROID_KEYSTORE_B64 }}" | base64 --decode > signing.jks
          chmod 600 signing.jks

          # Select APK paths
          UNSIGNED_APK="$(ls -1 ./artifacts/*.apk | head -n 1)"
          SIGNED_APK="./artifacts/signed-$(basename "$UNSIGNED_APK")"

          # Sign + verify
          $ANDROID_SDK_ROOT/build-tools/34.0.0/apksigner sign \
            --ks signing.jks \
            --ks-key-alias "${{ vars.ANDROID_KEY_ALIAS }}" \
            --ks-pass "pass:${{ secrets.ANDROID_KEYSTORE_PASSWORD }}" \
            --key-pass "pass:${{ secrets.ANDROID_KEYSTORE_PASSWORD }}" \
            --out "$SIGNED_APK" \
            "$UNSIGNED_APK"

          $ANDROID_SDK_ROOT/build-tools/34.0.0/apksigner verify --verbose "$SIGNED_APK"

          # Cleanup
          rm -f signing.jks
          rm -f "$UNSIGNED_APK"

      - name: Upload signed test APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: letterbox-staging-signed-apk
          path: ./artifacts/*.apk
          retention-days: 14
