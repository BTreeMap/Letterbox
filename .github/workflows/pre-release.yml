name: Pre-release

on:
  workflow_run:
    workflows: ["Build"]
    types: [completed]
    branches: ["main"]

permissions:
  contents: write  # Required for creating releases
  actions: read    # Required to download artifacts

jobs:
  pre-release:
    name: Create Pre-release
    runs-on: ubuntu-latest
    environment: ci:release
    # Only run if build succeeded and on main branch
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}
          fetch-depth: 0  # Full git history for version calculation
          fetch-tags: true

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android build tools
        run: |
          sdkmanager "build-tools;34.0.0"

      - name: Download prod release APK from build workflow
        uses: actions/download-artifact@v4
        with:
          name: letterbox-prod-release-unsigned-apk
          path: ./artifacts
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}

      - name: List downloaded artifacts
        run: ls -la ./artifacts

      - name: Sign APK
        run: |
          set -euo pipefail
          umask 077

          # Rehydrate keystore
          printf '%s' "${{ secrets.ANDROID_KEYSTORE_B64 }}" | base64 --decode > signing.jks
          chmod 600 signing.jks

          # Select APK paths
          UNSIGNED_APK="$(ls -1 ./artifacts/*.apk | head -n 1)"
          SIGNED_APK="./artifacts/signed-$(basename "$UNSIGNED_APK")"

          # Sign + verify
          $ANDROID_SDK_ROOT/build-tools/34.0.0/apksigner sign \
            --ks signing.jks \
            --ks-key-alias "${{ vars.ANDROID_KEY_ALIAS }}" \
            --ks-pass "pass:${{ secrets.ANDROID_KEYSTORE_PASSWORD }}" \
            --key-pass "pass:${{ secrets.ANDROID_KEYSTORE_PASSWORD }}" \
            --out "$SIGNED_APK" \
            "$UNSIGNED_APK"

          $ANDROID_SDK_ROOT/build-tools/34.0.0/apksigner verify --verbose "$SIGNED_APK"

          # Cleanup
          rm -f signing.jks
          rm -f "$UNSIGNED_APK"

      - name: Get version info
        id: version
        run: |
          # Get the latest version tag matching v*.*.*
          VERSION_TAG=$(git describe --tags --match "v[0-9]*.[0-9]*.[0-9]*" --abbrev=0 2>/dev/null || echo "")
          
          # Extract version components
          VERSION_REGEX='^v([0-9]+)\.([0-9]+)\.([0-9]+)$'
          if [[ -n "$VERSION_TAG" && $VERSION_TAG =~ $VERSION_REGEX ]]; then
            MAJOR="${BASH_REMATCH[1]}"
            MINOR="${BASH_REMATCH[2]}"
            PATCH="${BASH_REMATCH[3]}"
          else
            # Fallback when no valid version tag exists
            MAJOR=0
            MINOR=0
            PATCH=0
            VERSION_TAG=""
          fi
          
          # Count commits since last tag (or all commits if no tag exists)
          if [ -n "$VERSION_TAG" ]; then
            COMMITS_SINCE_TAG=$(git rev-list --count HEAD "^$VERSION_TAG")
          else
            COMMITS_SINCE_TAG=$(git rev-list --count HEAD)
          fi
          
          # Get short SHA
          SHORT_SHA=$(git rev-parse --short HEAD)
          
          # Generate version name (matches Gradle logic)
          if [ "$COMMITS_SINCE_TAG" -eq 0 ]; then
            VERSION_NAME="${MAJOR}.${MINOR}.${PATCH}"
          else
            VERSION_NAME="${MAJOR}.${MINOR}.${PATCH}-dev.${COMMITS_SINCE_TAG}+${SHORT_SHA}"
          fi
          
          echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "Version: $VERSION_NAME"

      - name: Create pre-release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: pre-release-${{ steps.version.outputs.short_sha }}
          name: Pre-release ${{ steps.version.outputs.version_name }}
          prerelease: true
          files: ./artifacts/*.apk
          body: |
            Automated pre-release from commit ${{ github.event.workflow_run.head_sha }}
            Version: ${{ steps.version.outputs.version_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
