name: Android UI Tests

on:
  workflow_run:
    workflows: ["Build"]
    types: [completed]
    branches: ["main", "copilot/**"]

permissions:
  contents: read
  actions: read  # Required to download artifacts from triggering workflow

jobs:
  ui-tests:
    name: Instrumented UI Tests
    runs-on: ubuntu-latest
    timeout-minutes: 60
    # Only run if the build workflow succeeded
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.workflow_run.head_sha }}
          fetch-depth: 0  # Full git history for version calculation
          fetch-tags: true

      - name: Enable KVM group perms
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: Set up JDK
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: "21"

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android components
        run: |
          sdkmanager "platform-tools" "platforms;android-34" "build-tools;34.0.0"
          sdkmanager "system-images;android-34;google_apis;x86_64"
          sdkmanager "emulator"

      - name: Accept Android licenses
        run: yes | sdkmanager --licenses

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-linux-android

      - name: Cache Cargo dependencies
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            rust/letterbox-core/target/
            rust/letterbox-proxy/target/
          key: cargo-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            cargo-${{ runner.os }}-

      - name: Install cargo-ndk
        run: |
          if ! command -v cargo-ndk &> /dev/null; then
            cargo install cargo-ndk --locked
          else
            echo "cargo-ndk already installed, skipping"
          fi

      - name: Install and pin NDK
        run: |
          sdkmanager --install "ndk;26.1.10909125"
          echo "ANDROID_NDK_HOME=$ANDROID_SDK_ROOT/ndk/26.1.10909125" >> $GITHUB_ENV

      - name: Gradle permissions
        run: chmod +x gradlew

      - name: Build Android native libraries for x86_64 (letterbox-core)
        run: |
          cargo ndk -t x86_64 -o ${{ github.workspace }}/app/src/main/jniLibs build --release
        working-directory: rust/letterbox-core

      - name: Build Android native libraries for x86_64 (letterbox-proxy)
        run: |
          cargo ndk -t x86_64 -o ${{ github.workspace }}/app/src/main/jniLibs build --release
        working-directory: rust/letterbox-proxy

      - name: Verify native libraries were generated
        run: |
          echo "Checking for generated .so files in jniLibs:"
          find ${{ github.workspace }}/app/src/main/jniLibs -maxdepth 2 -type f -name "*.so" -print
          if [ -z "$(find ${{ github.workspace }}/app/src/main/jniLibs -maxdepth 2 -type f -name "*.so")" ]; then
            echo "ERROR: No .so files found in jniLibs!"
            exit 1
          fi
          echo "Verifying both letterbox_core and letterbox_proxy libraries:"
          find ${{ github.workspace }}/app/src/main/jniLibs -type f -name "*letterbox_core*.so" | head -1 || (echo "ERROR: letterbox_core not found!" && exit 1)
          find ${{ github.workspace }}/app/src/main/jniLibs -type f -name "*letterbox_proxy*.so" | head -1 || (echo "ERROR: letterbox_proxy not found!" && exit 1)

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@4d9f0ba0025fe599b4ebab900eb7f3a1d93ef4c2  # v5.0.0

      - name: Run instrumented UI tests (Gradle Managed Devices)
        run: |
          ./gradlew pixel7Api34StagingDebugAndroidTest \
            --no-daemon \
            -Pandroid.testoptions.manageddevices.emulator.gpu=swiftshader_indirect \
            -Pandroid.experimental.testOptions.managedDevices.setupTimeoutMinutes=30 \
            -Pandroid.experimental.testOptions.managedDevices.maxConcurrentDevices=1

      - name: Collect debug artifacts (always)
        if: always()
        run: |
          mkdir -p artifacts

          # Restart adb server to prevent hangs (best-effort)
          timeout 20s adb kill-server || true
          timeout 20s adb start-server || true

          # Capture device state if any device is still connected (with timeout to prevent hangs)
          timeout 10s adb devices || true
          timeout 30s adb logcat -d > artifacts/logcat.txt 2>&1 || true
          timeout 10s adb exec-out screencap -p > artifacts/final-screen.png 2>&1 || true

          # Collect Gradle test reports
          cp -r app/build/reports artifacts/ 2>/dev/null || true
          cp -r app/build/outputs/androidTest-results artifacts/ 2>/dev/null || true
          cp -r app/build/outputs/managed_device_android_test_additional_output artifacts/ 2>/dev/null || true

          echo "Artifacts collected:"
          ls -la artifacts/ || true

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: android-ui-test-artifacts
          path: artifacts/
          retention-days: 14
